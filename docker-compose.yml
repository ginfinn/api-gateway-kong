version: '3.8'

services:
  # PostgreSQL для Kong
  kong-database:
    image: postgres:15-alpine
    container_name: kong-database
    environment:
      POSTGRES_USER: ${KONG_DB_USER:-kong}
      POSTGRES_PASSWORD: ${KONG_DB_PASSWORD}  # ОБЯЗАТЕЛЬНО установить в .env!
      POSTGRES_DB: ${KONG_DB_NAME:-kong}
    volumes:
      - kong_data:/var/lib/postgresql/data
    networks:
      - api-gateway-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${KONG_DB_USER:-kong}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Kong API Gateway
  kong:
    image: kong:3.4
    container_name: kong
    restart: unless-stopped
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_USER: ${KONG_DB_USER:-kong}
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD}  # ОБЯЗАТЕЛЬНО установить в .env!
      KONG_PG_DATABASE: ${KONG_DB_NAME:-kong}
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_ADMIN_GUI_LISTEN: 0.0.0.0:8002
      # Безопасность: ограничить доступ к admin API только из внутренней сети
      KONG_ADMIN_GUI_URL: http://localhost:8002
    networks:
      - api-gateway-network
    depends_on:
      kong-database:
        condition: service_healthy
    volumes:
      - ./kong/kong.yml:/kong/declarative/kong.yml:ro
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Keycloak (PRODUCTION MODE)
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: keycloak
    restart: unless-stopped
    # ИСПРАВЛЕНО: Использование production режима вместо start-dev
    command: start
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-database
      KC_DB_URL_DATABASE: ${KEYCLOAK_DB_NAME:-keycloak}
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER:-keycloak}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD}  # ОБЯЗАТЕЛЬНО установить в .env!
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-auth.example.com}
      KC_HOSTNAME_STRICT_HTTPS: true
      KC_HTTP_ENABLED: true
      KC_HTTP_PORT: 8080
      # ИСПРАВЛЕНО: Пароль администратора из переменной окружения
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}  # ОБЯЗАТЕЛЬНО установить в .env!
      # Production настройки
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
    networks:
      - api-gateway-network
    depends_on:
      keycloak-database:
        condition: service_healthy
    volumes:
      - keycloak_data:/opt/keycloak/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Keycloak требует больше времени на старт
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # PostgreSQL для Keycloak
  keycloak-database:
    image: postgres:15-alpine
    container_name: keycloak-database
    environment:
      POSTGRES_USER: ${KEYCLOAK_DB_USER:-keycloak}
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD}  # ОБЯЗАТЕЛЬНО установить в .env!
      POSTGRES_DB: ${KEYCLOAK_DB_NAME:-keycloak}
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    networks:
      - api-gateway-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${KEYCLOAK_DB_USER:-keycloak}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Nginx с mTLS
  nginx:
    image: nginx:alpine
    container_name: nginx-mtls
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    networks:
      - api-gateway-network
    depends_on:
      - kong
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

volumes:
  kong_data:
  keycloak_data:
  keycloak_db_data:

networks:
  api-gateway-network:
    driver: bridge
